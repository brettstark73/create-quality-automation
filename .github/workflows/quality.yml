name: Quality Checks

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "No package-lock.json found; running npm install"
            npm install
          fi

      - name: Verify dependency integrity
        run: |
          echo "ðŸ” Verifying dependency integrity..."
          # Verify package-lock.json integrity hashes
          if [ -f package-lock.json ]; then
            npm ci --dry-run --prefer-offline
            echo "âœ… Dependency integrity verified"
          else
            echo "âš ï¸ No package-lock.json found - skipping integrity verification"
          fi

          # Check for known vulnerabilities in dependencies
          echo "ðŸ” Checking for vulnerable dependencies..."
          npm audit --audit-level=moderate || true

          # Verify npm package signatures (Node.js 16+)
          if command -v npm &> /dev/null; then
            echo "âœï¸ Verifying npm package signatures..."
            npm audit signatures || echo "âš ï¸ Signature verification not available or failed"
          fi

      - name: Prettier check
        run: npm run format:check

      - name: ESLint
        run: npx eslint . --ext .js,.jsx,.ts,.tsx,.html --max-warnings=0

      - name: Stylelint
        run: npx stylelint "**/*.{css,scss,sass,less,pcss}" --allow-empty-input

      - name: Security audit
        run: npm audit --audit-level high

      - name: Check for hardcoded secrets
        run: |
          # Check for common secret patterns (excluding workflow files)
          if grep -r -E "(password|secret|key|token).*[=:].*['\"][^'\"]{8,}" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.github || \
             grep -r -E "-----BEGIN.*KEY-----" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.github; then
            echo "âŒ Potential hardcoded secrets found"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

      - name: Security pattern detection
        run: |
          # Check for XSS vulnerability patterns from WFHroulette
          echo "ðŸ” Scanning for XSS vulnerability patterns..."

          # Check for innerHTML with interpolation (dangerous pattern)
          if grep -r -E "innerHTML.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: innerHTML with template literal interpolation found"
            exit 1
          fi

          # Check for eval with interpolation
          if grep -r -E "eval\\\(.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential code injection: eval with interpolation found"
            exit 1
          fi

          # Check for document.write with interpolation
          if grep -r -E "document\\\\.write.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: document.write with interpolation found"
            exit 1
          fi

          # Check for onclick handlers with interpolation
          if grep -r -E "onclick.*=.*['\"].*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --include="*.html" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: onclick handler with interpolation found"
            exit 1
          fi

          echo "âœ… No XSS vulnerability patterns detected"

      - name: Input validation check
        run: |
          # Check for proper input validation patterns
          echo "ðŸ” Checking for input validation patterns..."

          # Set pipefail to catch grep failures properly
          set -o pipefail

          # Look for unvalidated user inputs in common patterns
          if grep -r -E "(req\\.query|req\\.params|req\\.body)\\.[a-zA-Z_][a-zA-Z0-9_]*[^\\.]" . --include="*.js" --include="*.ts" --exclude-dir=node_modules | grep -v -E "(trim|toLowerCase|toUpperCase|parseInt|parseFloat|Number\\.isNaN|String|Boolean)" > /tmp/unvalidated_inputs.txt 2>/dev/null && [ -s /tmp/unvalidated_inputs.txt ]; then
            echo "âš ï¸ Found potential unvalidated user inputs (review manually):"
            head -5 /tmp/unvalidated_inputs.txt
            echo "This is a warning, not a failure. Review these patterns manually."
          else
            echo "âœ… No unvalidated user inputs detected"
          fi

          # Clean up temp file
          rm -f /tmp/unvalidated_inputs.txt

      - name: Configuration security check
        run: |
          # Check for configuration security issues
          if [ -f "setup.js" ]; then
            echo "ðŸ” Running configuration security validation..."
            node setup.js --security-config
          else
            echo "â­ï¸ No setup.js found, running basic security checks..."

            # Basic Next.js env block check
            if find . -name "next.config.*" -type f | head -1 | xargs grep -l "env:" 2>/dev/null; then
              echo "âš ï¸ Next.js env block found - manually verify no secrets are exposed to client"
            fi

            # Basic Vite env check
            if find . -name "vite.config.*" -type f | head -1 | xargs grep -l "VITE_.*SECRET\|VITE_.*PASSWORD\|VITE_.*KEY" 2>/dev/null; then
              echo "âŒ VITE_ prefixed secrets detected - these are exposed to client!"
              exit 1
            fi
          fi

      - name: Documentation validation
        run: |
          # Validate documentation accuracy
          if [ -f "setup.js" ]; then
            echo "ðŸ“– Running documentation validation..."
            node setup.js --validate-docs
          else
            echo "â­ï¸ No setup.js found, skipping documentation validation"
          fi

      - name: Lighthouse CI
        run: |
          # Only run Lighthouse CI if configuration exists
          if [ -f ".lighthouserc.js" ] || [ -f ".lighthouserc.json" ] || [ -f "lighthouserc.js" ]; then
            echo "ðŸš¢ Running Lighthouse CI..."
            npx lhci autorun
          else
            echo "â­ï¸ No Lighthouse CI configuration found, skipping"
          fi
        continue-on-error: true

      - name: Test README Quick Start Instructions
        run: |
          # Test that the README Quick Start actually works from a clean environment
          echo "ðŸ“š Testing README Quick Start instructions..."

          # Create temporary test directory
          TEST_DIR=$(mktemp -d)
          cd "$TEST_DIR"

          echo "ðŸ“¦ Creating minimal test project..."
          # Initialize git repo (required by setup.js)
          git init
          git config user.email "ci@example.com"
          git config user.name "CI Test"

          # Create minimal package.json as shown in Quick Start
          cat > package.json <<'EOF'
          {
            "name": "readme-test",
            "version": "1.0.0",
            "description": "Testing README Quick Start",
            "keywords": ["test"],
            "license": "MIT"
          }
          EOF

          # Run the exact command from README: npx create-quality-automation@latest
          # Since we're in CI testing the current version, use the local setup.js
          echo "ðŸš€ Running: npx create-quality-automation@latest"
          node "$GITHUB_WORKSPACE/setup.js"

          # Verify files were created (as promised in README)
          echo "âœ… Verifying setup results..."

          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found"
            exit 1
          fi

          if [ ! -f ".prettierrc" ]; then
            echo "âŒ .prettierrc not created"
            exit 1
          fi

          if [ ! -f ".prettierignore" ]; then
            echo "âŒ .prettierignore not created"
            exit 1
          fi

          # Test npm install (as instructed in README)
          echo "ðŸ“¦ Running: npm install"
          npm install --ignore-scripts

          # Test npm run prepare (as instructed in README)
          echo "ðŸª Running: npm run prepare"
          npm run prepare

          # Verify Husky hooks were installed
          if [ ! -d ".husky" ]; then
            echo "âŒ Husky hooks not installed"
            exit 1
          fi

          echo "âœ… README Quick Start instructions verified successfully!"

          # Clean up
          cd "$GITHUB_WORKSPACE"
          rm -rf "$TEST_DIR"
